tamanho_tabuleiro(9). %(9x9)

estado_inicial(e([v(p(1, 1), [1,2,3,4,5,6,7,8,9], _), v(p(1, 3), [1,2,3,4,5,6,7,8,9], _), v(p(1, 4), [1,2,3,4,5,6,7,8,9], _), v(p(1, 5), [1,2,3,4,5,6,7,8,9], _), v(p(1, 7), [1,2,3,4,5,6,7,8,9], _),
                v(p(2, 1), [1,2,3,4,5,6,7,8,9], _), v(p(2, 2), [1,2,3,4,5,6,7,8,9], _), v(p(2, 3), [1,2,3,4,5,6,7,8,9], _), v(p(2, 5), [1,2,3,4,5,6,7,8,9], _), v(p(2, 7), [1,2,3,4,5,6,7,8,9], _), v(p(2, 8), [1,2,3,4,5,6,7,8,9], _), v(p(2, 9), [1,2,3,4,5,6,7,8,9], _),
                v(p(3, 2), [1,2,3,4,5,6,7,8,9], _), v(p(3, 3), [1,2,3,4,5,6,7,8,9], _), v(p(3, 4), [1,2,3,4,5,6,7,8,9], _), v(p(3, 5), [1,2,3,4,5,6,7,8,9], _), v(p(3, 6), [1,2,3,4,5,6,7,8,9], _), v(p(3, 8), [1,2,3,4,5,6,7,8,9], _),
                v(p(4, 1), [1,2,3,4,5,6,7,8,9], _), v(p(4, 2), [1,2,3,4,5,6,7,8,9], _), v(p(4, 3), [1,2,3,4,5,6,7,8,9], _), v(p(4, 4), [1,2,3,4,5,6,7,8,9], _), v(p(4, 5), [1,2,3,4,5,6,7,8,9], _), v(p(4, 7), [1,2,3,4,5,6,7,8,9], _), v(p(4, 8), [1,2,3,4,5,6,7,8,9], _), v(p(4, 9), [1,2,3,4,5,6,7,8,9], _),
                v(p(5, 1), [1,2,3,4,5,6,7,8,9], _), v(p(5, 2), [1,2,3,4,5,6,7,8,9], _), v(p(5, 3), [1,2,3,4,5,6,7,8,9], _), v(p(5, 4), [1,2,3,4,5,6,7,8,9], _), v(p(5, 7), [1,2,3,4,5,6,7,8,9], _), 
                v(p(6, 2), [1,2,3,4,5,6,7,8,9], _), v(p(6, 3), [1,2,3,4,5,6,7,8,9], _), v(p(6, 5), [1,2,3,4,5,6,7,8,9], _), v(p(6, 6), [1,2,3,4,5,6,7,8,9], _), v(p(6, 7), [1,2,3,4,5,6,7,8,9], _), v(p(6, 8), [1,2,3,4,5,6,7,8,9], _), v(p(6, 9), [1,2,3,4,5,6,7,8,9], _),
                v(p(7, 1), [1,2,3,4,5,6,7,8,9], _), v(p(7, 2), [1,2,3,4,5,6,7,8,9], _), v(p(7, 3), [1,2,3,4,5,6,7,8,9], _), v(p(7, 5), [1,2,3,4,5,6,7,8,9], _), v(p(7, 6), [1,2,3,4,5,6,7,8,9], _), v(p(7, 7), [1,2,3,4,5,6,7,8,9], _), v(p(7, 8), [1,2,3,4,5,6,7,8,9], _), v(p(7, 9), [1,2,3,4,5,6,7,8,9], _),
                v(p(8, 3), [1,2,3,4,5,6,7,8,9], _), v(p(8, 4), [1,2,3,4,5,6,7,8,9], _), v(p(8, 6), [1,2,3,4,5,6,7,8,9], _), v(p(8, 7), [1,2,3,4,5,6,7,8,9], _), v(p(8, 9), [1,2,3,4,5,6,7,8,9], _), 
                v(p(9, 1), [1,2,3,4,5,6,7,8,9], _), v(p(9, 2), [1,2,3,4,5,6,7,8,9], _), v(p(9, 4), [1,2,3,4,5,6,7,8,9], _), v(p(9, 5), [1,2,3,4,5,6,7,8,9], _), v(p(9, 7), [1,2,3,4,5,6,7,8,9], _), v(p(9, 8), [1,2,3,4,5,6,7,8,9], _), v(p(9, 9), [1,2,3,4,5,6,7,8,9], _)],
               [v(p(1, 2), [1,2,3,4,5,6,7,8,9], 1), v(p(1, 6), [1,2,3,4,5,6,7,8,9], 8), v(p(1, 8), [1,2,3,4,5,6,7,8,9], 7), v(p(1, 9), [1,2,3,4,5,6,7,8,9], 3),
                v(p(2, 4), [1,2,3,4,5,6,7,8,9], 5), v(p(2, 6), [1,2,3,4,5,6,7,8,9], 9),
                v(p(3, 1), [1,2,3,4,5,6,7,8,9], 7), v(p(3, 7), [1,2,3,4,5,6,7,8,9], 9), v(p(3, 9), [1,2,3,4,5,6,7,8,9], 4),
                v(p(4, 6), [1,2,3,4,5,6,7,8,9], 4),
                v(p(5, 5), [1,2,3,4,5,6,7,8,9], 3), v(p(5, 6), [1,2,3,4,5,6,7,8,9], 5), v(p(5, 8), [1,2,3,4,5,6,7,8,9], 1), v(p(5, 9), [1,2,3,4,5,6,7,8,9], 8),
                v(p(6, 1), [1,2,3,4,5,6,7,8,9], 8), v(p(6, 4), [1,2,3,4,5,6,7,8,9], 9),
                v(p(7, 4), [1,2,3,4,5,6,7,8,9], 7),
                v(p(8, 1), [1,2,3,4,5,6,7,8,9], 2), v(p(8, 2), [1,2,3,4,5,6,7,8,9], 6), v(p(8, 5), [1,2,3,4,5,6,7,8,9], 4), v(p(8, 8), [1,2,3,4,5,6,7,8,9], 3),
                v(p(9, 3), [1,2,3,4,5,6,7,8,9], 5), v(p(9, 6), [1,2,3,4,5,6,7,8,9], 3)])).

% Tabuleiro resultante do estado inicial
/*
-------------------------------------
|   | 1 |   |   |   | 8 |   | 7 | 3 |
|---|---|---|---|---|---|---|---|---|
|   |   |   | 5 |   | 9 |   |   |   |
|---|---|---|---|---|---|---|---|---|
| 7 |   |   |   |   |   | 9 |   | 4 |
|---|---|---|---|---|---|---|---|---|
|   |   |   |   |   | 4 |   |   |   |
|---|---|---|---|---|---|---|---|---|
|   |   |   |   | 3 | 5 |   | 1 | 8 |
|---|---|---|---|---|---|---|---|---|
| 8 |   |   | 9 |   |   |   |   |   |
|---|---|---|---|---|---|---|---|---|
|   |   |   | 7 |   |   |   |   |   |
|---|---|---|---|---|---|---|---|---|
| 2 | 6 |   |   | 4 |   |   | 3 |   |
|---|---|---|---|---|---|---|---|---|
|   |   | 5 |   |   | 3 |   |   |   |
-------------------------------------
*/

%Restricoes 
ve_restricoes(E):-
  ver_linhas(E),
  ver_colunas(E),
  ver_quadrantes(E).


ver_linhas(e(Nafect,[v(p(X,Y), D, V)|R])):-
  findall(V1,member(v(p(X,_),_,V1),R),L),
   todos_diff([V|L]).
  
ver_colunas(e(Nafect,[v(p(X,Y), D, V)|R])):-
  findall(V1,member(v(p(_,Y),_,V1),R),L),
  todos_diff([V|L]).


ver_quadrantes(e(_,Afect)) :-
  ver_quad(Afect, 1, 1, 3, Q1),
  todos_diff(Q1),
  ver_quad(Afect, 1, 4, 6, Q2),
  todos_diff(Q2),
  ver_quad(Afect, 1, 7, 9, Q3),
  todos_diff(Q3),
  ver_quad(Afect, 4, 1, 3, Q4),
  todos_diff(Q4),
  ver_quad(Afect, 4, 4, 6, Q5),
  todos_diff(Q5),
  ver_quad(Afect, 4, 7, 9, Q6),
  todos_diff(Q6),
  ver_quad(Afect, 7, 1, 3, Q7),
  todos_diff(Q7),
  ver_quad(Afect, 7, 4, 6, Q8),
  todos_diff(Q8),
  ver_quad(Afect, 7, 7, 9, Q9),
  todos_diff(Q9).


ver_quad(L, X, Y, Y2, Q) :-
  Y = Y2, X1 is X+2,
  add_quad(L, X, Y, X1, Q).

ver_quad(L, X, Y, Y2, Q) :-
  Y < Y2, Y1 is Y+1,
  X1 is X+2,
  add_quad(L, X, Y, X1, L1),
  append(L1, L2, Q),
  ver_quad(L, X, Y1, Y2, L2).

add_quad(L, X, Y, X2, []) :-
  X = X2,
  \+member(v(p(X, Y), _, _), L).

add_quad(L, X, Y, X2, [V]) :-
  X = X2,
  member(v(p(X, Y), _, V), L).

add_quad(L, X, Y, X2, T) :-
  X < X2, X1 is X+1,
  \+member(v(p(X, Y), _, _), L),
  add_quad(L, X1, Y, X2, T).

add_quad(L, X, Y, X2, [V|T]) :-
  X < X2,
  member(v(p(X, Y), _, V), L),
  X1 is X+1,
  add_quad(L, X1, Y, X2, T).


% verifica se os elementos numa lista sao todos diferentes
todos_diff([]).
todos_diff([X|R]):-
  \+ member(X,R), todos_diff(R).


% função de print
esc(L):-sort(L, L1), esc_a(L1),nl.
esc_a(L):- tamanho_tabuleiro(S), esc_l(L, 1, S).

esc_l([H], S, S):-
  H = v(_,_,X), write(X),nl.

esc_l([H|T], S, S):-
  H = v(_,_,X), write(X), nl,
  esc_l(T, 1, S).

esc_l([H|T], I, S):- 
  I<S, I2 is I+1,
  H = v(_,_,X), write(X),write(' . '),
  esc_l(T, I2, S).

% função sucessor
sucessor(e([v(N,D,_)|R],E),e(R,[v(N,D,V)|E])):- 
    member(V,D).


% função BackTracking 
back(e([],A),A).
back(E,Sol):- 
	  sucessor(E,E1), 
	  ve_restricoes(E1),
    back(E1,Sol).


% função forward checking
forward(e([],A),A).
forward(E,Sol):- 
    sucessor(E,E1),
    ve_restricoes(E1), 
    forCheck(E1, E2),
    forward(E2, Sol).

forCheck(e(Lni,[v(N,D,V)|Li]), e(Lnii, [v(N,D,V)|Li])) :- corta(V,Lni,Lnii).

corta(_,[],[]).
corta(V,[v(N,D,_)|NAfect],[v(N,DS,_)|NAfectS]):-  
    corta(V, NAfect, NAfectS).

sudoku_back:- 
    estado_inicial(E0), 
    back(E0,A), 
    esc(A).


sudoku_forward:-
  estado_inicial(E0),
  forward(E0,A), 
  esc(A).
